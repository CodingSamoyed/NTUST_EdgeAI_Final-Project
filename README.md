# README.md

---

This repository is for Edge_AI final project, lectured by Prof. Jack Hsu in the duration of spring semester in 2023, at NTUST. 

For detailed information of how the project is proceeded, please visit the link below. At here, the focus is how to run the codes correctly.



[:link:](https://hackmd.io/@CodingSamoyed/Hy_hFTyvh
) (Please be noted due to the course is given in mandarin, the content is written with traditional chinese)

---

## Project Name：Application of Selected Dog Breeds Prediction Based on Edge Device

---

### Few things about this repository before getting started...

- Most parts of the code ```Train.ipynb``` is referenced from the link here：[:link:](https://www.kaggle.com/code/jasonhcwong/dog-breed-classification-using-efficientnet/notebook), except for the model-converting part.

- All the inference-related codes are provided with 2 versions, ```.py``` and ```.ipynb```,  to have the reference of previous results generated by author.

- All the dataset colleted by author is from **Instagram by screenshots with smartphone**, and the annotations are done with **lableIMG**, for more information of labelIMG please visit the link here[:link:](https://github.com/heartexlabs/labelImg).

- The version of important tools that the inference is proceeded with：
```    
    - Python：3.10.7
    - Tensorflow：2.12.0
    - Numpy：1.23.4 
    - PIL：9.2.0
```
---

**Step by step to run the codes and get the results**

---

### Dataset

- Please visit the link to download the dataset used in this project：[:link:](https://drive.google.com/drive/folders/1rMLp9ssUu0OhYDz5JWmjKH3sVl_Ad3Su?usp=drive_link)
- In the link provided, there are 4 kinds of datasets：

    - **Stanford_Dogs**：Including both images and its annotation files of the 8 breeds selected to do the classification, and the data is orignated from public dataset "Stanford Dogs Dataset". For more detail, please visit the link：[:link:](http://vision.stanford.edu/aditya86/ImageNetDogs/main.html
).
    - **My_Data**：Including both images and its annotation files of the 8 breeds selected to do the classification. 
    - **Hybrid**：Basically it's the combining of Stanford_Dogs & My_Data, and with all the annotation files from Stanford_Dogs changed their format to ```.xml```. 
    - **Test**：Same collecting method as My_Data, without annotations.
- This section is optional if you would like to train with your own dataset, just remeber the ==annotation is necessary== since the images will be preprocessed before trainin, for more detail please visit the section of **"Prepare images for training"** in ```Train.ipynb```.

### Model Training

- For training, run ```Train.ipynb```, and few things need to be checked before executing the code as below：
    - (Optional) If you plan to train the model with **Google Colab**, and the data will be placed in Google Dirve, run ```drive.mount('/content/drive')```.

    - Set the related file paths in the "variables and initialization" section, detailed code is shown as below：
       ```       
        data_dir = "path_to_training_data "
        annotations_dir = "path_to_annotation_data"
        cropped_dir = "path_to_save_preprocessed_data"
        checkpoint_path = "path_to_save_variables_during_training"
        ```
    - If you are training only with Stanford_Dogs, adjust the code into the state as shown below in "Prepare images for training" section：
       ```       
        # tree = ET.parse(annotation+".xml")                   
        tree = ET.parse(annotation)       
        ```
    - Set the related file path in the "Save the model" & "Convert saved Keras model into TensorFlowLite format" section, detailed code is shown as below：
       ```       
        model.save('path_to_save_model')
        ```
        ```
         keras_model = tf.keras.models.load_model('path_to_saved_original_model')
        ```
- If the training process is sucessful, you should get file "Model" saved with several files like shown as below, and a ```model.tflite``` file converted from "Model".

    ```
        ├── Model(file)
            ├── assets(file)            
            ├── variables(file)  
            ├── fingerprint.pb
            ├── keras_metadata.pb
            ├── saved_model.pb
- Here is the link to download the models trained by author and used in this project, for your reference：[:link:](https://drive.google.com/drive/folders/1aCieqwfDkA6xA6dhnW59iOm0tH1Qh9Tn?usp=sharing)

---



### Inference

After the completion of model training, let's get dog images classfied into selected breeds！

- First of all, run ```Demo.py``` or ```Demo.ipynb``` with your original models, and two file paths needed to be set up as shown below： 
    ```
    model_path = 'path_to_model(file)' 
    ```
    ```
    folder_path = 'path_to_file_where_images_wait_to_be_predicted'  
    ```

- Secondly, run ```Demo_tflite.py``` or ```Demo_tflite.ipynb``` with your converted models, and two file paths needed to be set up as shown below： 
    ```
    interpreter = tf.lite.Interpreter("path_to_model(.tflite)")
    ```
    ```
    folder_path = 'path_to_file_where_images_wait_to_be_predicted' 
    ```
- (Optional)：If you are training with your own dataset and with your own labeling, please revise the label contents with correct sequence, which should be identical to how your training data is filed. 
    ```
    labels = ['label1','label2','label3'...]  
    ```

- By completing the steps as above, you should get the classification results with prediction confidence index,here is a example of the output：

    ![](https://hackmd.io/_uploads/r1I7xUGPn.png)


- Finally, run```TestAllAcc.py``` or ```TestAllAcc.ipynb``` with your original and converted models, to figure out the overall accuracy. A few things need to be checked before executing the code as below：

    - Make sure the test images are placed correctly into its file of breed according to code defined as below, also the contents sequence should be indentical to which how your training data is filed. ：
    
        ```
        def DataGenerator(file_path, batch_size):
    
            ...
            
            classes={
                     'label_1': 0,
                     'labe_2': 1,
                     
                     ...
                     
                     'lable_x': x-1,
                     },
                     
            ...       

    - Set the file paths to link your Test dataset, and set input batch size in accordance with your hardware memory：
    
        ```
        test_dataset = DataGenerator(file_path = 'Path_to_test_dataset', batch_size=depends_on_your_HW_Memory)
        ```

    - Try to set names of the original and converted models names identical, only with the difference of its filing format, and have the models put in the same layer of code, so by running ```TestAllAcc.py``` or ```TestAllAcc.ipynb```, it can output all the test accuracy results at once. Here shows how the codes are written：
    
        ```
        for model_name in ["Model_Name_1", "Model_Name_2", "Model_Name_3"]:

            model_path = model_name
            model = tf.keras.models.load_model(model_path)
            
            ...
            
            interpreter = tf.lite.Interpreter(model_path=f"{model_path}.tflite")
            
            ...
        ```

---